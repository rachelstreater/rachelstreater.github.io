<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en"><generator uri="https://jekyllrb.com/" version="4.3.2">Jekyll</generator><link href="https://rachelstreater.com/feed.xml" rel="self" type="application/atom+xml" /><link href="https://rachelstreater.com/" rel="alternate" type="text/html" hreflang="en" /><updated>2023-06-01T15:22:53+00:00</updated><id>https://rachelstreater.com/feed.xml</id><title type="html">blank</title><subtitle>Senior Machine Learning Engineer based in London
</subtitle><entry><title type="html">Code Snippet - Using a geolocation API with Pandas</title><link href="https://rachelstreater.com/blog/2023/testing-coordinate-conversion/" rel="alternate" type="text/html" title="Code Snippet - Using a geolocation API with Pandas" /><published>2023-06-01T00:00:00+00:00</published><updated>2023-06-01T00:00:00+00:00</updated><id>https://rachelstreater.com/blog/2023/testing-coordinate-conversion</id><content type="html" xml:base="https://rachelstreater.com/blog/2023/testing-coordinate-conversion/"><![CDATA[<p>We have a dataframe with location in X/Y format, which we want to convert to Latitude/Longitude and put back into the dataframe for plotting and analysis.</p>

<p>Create a function to query the API. Need to define the API url and parameters.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">requests</span>

<span class="k">def</span> <span class="nf">bng_to_lat_lon</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">api_url</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">'</span><span class="s">http://webapps.bgs.ac.uk/data/webservices/CoordConvert_LL_BNG.cfc?method=BNGtoLatLng</span><span class="sh">'</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">response</span><span class="p">.</span><span class="nf">json</span><span class="p">()[</span><span class="sh">'</span><span class="s">LATITUDE</span><span class="sh">'</span><span class="p">],</span> <span class="n">response</span><span class="p">.</span><span class="nf">json</span><span class="p">()[</span><span class="sh">'</span><span class="s">LONGITUDE</span><span class="sh">'</span><span class="p">]]</span>
    <span class="k">except</span> <span class="n">requests</span><span class="p">.</span><span class="n">exceptions</span><span class="p">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>

</code></pre></div></div>

<p>Build the request parameters by creating a dictionary from the pandas dataframe:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">request</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="sh">'</span><span class="s">easting</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">northing</span><span class="sh">'</span><span class="p">]].</span><span class="nf">set_index</span><span class="p">(</span><span class="sh">'</span><span class="s">location_index</span><span class="sh">'</span><span class="p">).</span><span class="nf">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="sh">'</span><span class="s">index</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<p>Update the new coordinates:</p>

<p>Make sure to name the parameters as the API expects them, in this case <em>easting</em> and <em>northing</em>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">request</span><span class="p">.</span><span class="n">index</span><span class="p">:</span>
    <span class="n">params</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">accident</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">][[</span><span class="sh">'</span><span class="s">easting</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">northing</span><span class="sh">'</span><span class="p">]])</span>
    <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span> <span class="o">=</span> <span class="nf">convert_bng_to_lat_lon</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">accident</span><span class="p">[</span><span class="sh">'</span><span class="s">latitude</span><span class="sh">'</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lat</span>
    <span class="n">accident</span><span class="p">[</span><span class="sh">'</span><span class="s">longitude</span><span class="sh">'</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lon</span>
</code></pre></div></div>

<p>Run the code and the update is complete.</p>

<h3 id="a-more-efficient-solution">A more efficient solution:</h3>

<p>In benchmark testing, the previous implementation processed 512 rows per minute, whereas the following method was able to process 40,814 rows per minute. The bottleneck was the API calls which were running at around 8 per second.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">pyproj</span> <span class="kn">import</span> <span class="n">Transformer</span>
<span class="n">transformer</span> <span class="o">=</span> <span class="n">Transformer</span><span class="p">.</span><span class="nf">from_crs</span><span class="p">(</span><span class="sh">"</span><span class="s">EPSG:27700</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">EPSG:4326</span><span class="sh">"</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">request</span><span class="p">.</span><span class="n">index</span><span class="p">:</span>
    <span class="n">lat_lon</span> <span class="o">=</span> <span class="n">transformer</span><span class="p">.</span><span class="nf">transform</span><span class="p">(</span><span class="n">accident</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="sh">'</span><span class="s">easting</span><span class="sh">'</span><span class="p">],</span> <span class="n">accident</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="sh">'</span><span class="s">northing</span><span class="sh">'</span><span class="p">])</span>
    <span class="n">accident</span><span class="p">[</span><span class="sh">'</span><span class="s">latitude</span><span class="sh">'</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lat_lon</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">accident</span><span class="p">[</span><span class="sh">'</span><span class="s">longitude</span><span class="sh">'</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lat_lon</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</code></pre></div></div>]]></content><author><name></name></author><category term="python," /><category term="geospatial" /><summary type="html"><![CDATA[Geolocation API in Pandas to convert coordinates with comparison to pyproj package]]></summary></entry></feed>